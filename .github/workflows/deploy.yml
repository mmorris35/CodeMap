name: Deploy to Production

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      target:
        description: "Deployment target"
        required: true
        default: "production"
        type: choice
        options:
          - production
          - staging

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Run tests
        run: pytest tests/ -v --cov=codemap --cov-report=xml
      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Lint with ruff
        run: ruff check codemap tests
      - name: Format check with ruff
        run: ruff format --check codemap tests

  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v4
        with:
          python-version: "3.11"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      - name: Type check with mypy
        run: mypy codemap/

  deploy:
    needs: [test, lint, typecheck]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event_name == 'workflow_dispatch'
    environment: production
    steps:
      - uses: actions/checkout@v4

      - name: Deploy to EC2
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          script_stop_on_error: true
          script: |
            set -e

            # Variables
            APP_DIR="/opt/codemap"
            VENV_DIR="${APP_DIR}/venv"
            SERVICE_NAME="codemap"
            DEPLOY_LOG="/tmp/codemap-deploy.log"

            echo "=== CodeMap Deployment Started ===" | tee -a "${DEPLOY_LOG}"
            echo "Timestamp: $(date -u +'%Y-%m-%d %H:%M:%S UTC')" | tee -a "${DEPLOY_LOG}"
            echo "Branch: main" | tee -a "${DEPLOY_LOG}"
            echo "Commit: $(git -C ${APP_DIR} rev-parse --short HEAD)" | tee -a "${DEPLOY_LOG}"

            # Step 1: Navigate to application directory
            cd "${APP_DIR}"
            echo "[1/5] Entering application directory: ${APP_DIR}" | tee -a "${DEPLOY_LOG}"

            # Step 2: Fetch latest code from main branch
            echo "[2/5] Fetching latest code from main branch..." | tee -a "${DEPLOY_LOG}"
            git fetch origin main >> "${DEPLOY_LOG}" 2>&1
            git reset --hard origin/main >> "${DEPLOY_LOG}" 2>&1
            NEW_COMMIT=$(git rev-parse --short HEAD)
            echo "    Current commit: ${NEW_COMMIT}" | tee -a "${DEPLOY_LOG}"

            # Step 3: Update Python dependencies
            echo "[3/5] Updating Python dependencies..." | tee -a "${DEPLOY_LOG}"
            if [ ! -d "${VENV_DIR}" ]; then
              echo "    Virtual environment not found, creating..." | tee -a "${DEPLOY_LOG}"
              python3.11 -m venv "${VENV_DIR}" >> "${DEPLOY_LOG}" 2>&1
            fi
            source "${VENV_DIR}/bin/activate"
            pip install --upgrade pip >> "${DEPLOY_LOG}" 2>&1
            pip install -e ".[api]" >> "${DEPLOY_LOG}" 2>&1
            deactivate
            echo "    Dependencies updated successfully" | tee -a "${DEPLOY_LOG}"

            # Step 4: Restart service
            echo "[4/5] Restarting CodeMap service..." | tee -a "${DEPLOY_LOG}"
            sudo systemctl daemon-reload >> "${DEPLOY_LOG}" 2>&1
            sudo systemctl restart "${SERVICE_NAME}" >> "${DEPLOY_LOG}" 2>&1

            # Wait for service to be ready
            echo "    Waiting for service to be ready..." | tee -a "${DEPLOY_LOG}"
            sleep 5

            # Step 5: Verify service is running
            echo "[5/5] Verifying service health..." | tee -a "${DEPLOY_LOG}"
            if systemctl is-active --quiet "${SERVICE_NAME}"; then
              echo "    Service is running" | tee -a "${DEPLOY_LOG}"
            else
              echo "    ERROR: Service failed to start" | tee -a "${DEPLOY_LOG}"
              systemctl status "${SERVICE_NAME}" >> "${DEPLOY_LOG}" 2>&1
              exit 1
            fi

            echo "=== Deployment completed successfully ===" | tee -a "${DEPLOY_LOG}"
            echo "New commit: ${NEW_COMMIT}" | tee -a "${DEPLOY_LOG}"

      - name: Verify deployment via health check
        run: |
          CLOUDFRONT_URL=${{ secrets.CLOUDFRONT_URL }}

          if [ -z "${CLOUDFRONT_URL}" ]; then
            echo "WARNING: CLOUDFRONT_URL not set, skipping health check"
            exit 0
          fi

          echo "Waiting for service to stabilize..."
          sleep 10

          echo "Checking health endpoint: https://${CLOUDFRONT_URL}/health"

          # Retry logic: 5 attempts with 5-second intervals
          MAX_ATTEMPTS=5
          ATTEMPT=1

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Health check attempt $ATTEMPT/$MAX_ATTEMPTS..."

            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
              -H "User-Agent: GitHub-Actions-HealthCheck" \
              "https://${CLOUDFRONT_URL}/health")

            if [ "$HTTP_CODE" = "200" ]; then
              echo "✓ Health check passed (HTTP 200)"
              exit 0
            else
              echo "  Got HTTP $HTTP_CODE, retrying..."
              if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
                sleep 5
              fi
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "✗ Health check failed after $MAX_ATTEMPTS attempts"
          exit 1

      - name: Deployment notification (success)
        if: success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'success',
              description: 'Deployment completed successfully',
              environment_url: 'https://${{ secrets.CLOUDFRONT_URL }}'
            }).catch(err => {
              console.log('Status creation skipped (no deployment context)');
            });

      - name: Deployment notification (failure)
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: context.payload.deployment?.id || 0,
              state: 'failure',
              description: 'Deployment failed',
              environment_url: 'https://${{ secrets.CLOUDFRONT_URL }}'
            }).catch(err => {
              console.log('Status creation skipped (no deployment context)');
            });

      - name: Upload deployment logs
        if: always()
        uses: actions/upload-artifact@v3
        with:
          name: deployment-logs
          path: /tmp/codemap-deploy.log
          retention-days: 30
